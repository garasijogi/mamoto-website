const btnPromo_addPromo=$(".btn-promo-add"),btnPromo_edit=".btn-promo-edit",btnPromo_remove=".btn-promo-remove",btnPromo_removeAll=$(".btn-promo-removeAll"),btnPromo_submit=$(".btn-promo-submit"),btnContent_add='<i class="fa fa-plus-circle"></i>&#09;Tambahkan Promo',btnContent_edit='<i class="fa fa-pencil-alt"></i>&#09;Edit Promo',container_promo_row=$(".promo-content"),container_promo_contentNo=$(".container-promo-contentNo"),container_promo_content=$(".container-promo-content");var cropper;const image_promo=$(".rr-promo-add-image"),image_promo_container=$(".image-promo-container"),image_promo_stack=$(".rr-promo-add-image-stack"),image_cropper=document.getElementById("cropper"),image_cropper_btn=$(".image-cropper-btn"),image_cropper_btn_cancel=$(".image-cropper-btn-cancel"),image_cropper_btn_zoomIn=$("#cropperZoomIn"),image_cropper_btn_zoomOut=$("#cropperZoomOut"),image_cropper_btn_rotateLeft=$("#cropperRotateLeft"),image_cropper_btn_rotateRight=$("#cropperRotateRight"),image_cropper_btn_modeDrag=$("#cropperModeDrag"),image_cropper_btn_modeCrop=$("#cropperModeCrop"),image_cropper_container=$(".image-cropper-container"),image_input=$("#inputImage"),image_spinner_src=$('input[name="spinner"]').val(),daterange_start=$('input[name="daterange_start"]').val(),daterange_end=$('input[name="daterange_end"]').val();let flag_previousRetrieveNull=!1;const formPromo=$("#formPromo"),image_default=$('input[name="image_default"]').val(),input_daterange=$('input[name="daterange"]'),input_image=$('input[name="photo"]'),input_name=$('input[name="name"]'),input_period=$('input[name="period"]'),textarea_post=$('textarea[name="post"]'),textarea_link=$('textarea[name="link"]');let edit_promo_id,edit_promo_originPhoto;const modal_promo=$("#modal_promo"),overlay_promo_modal=$(".overlay-promo-modal"),spinner_promo=$(".promo-spinner");let toggle_form="add";const token_csrf=$('input[name="token_csrf"]').val(),url_formAdd=$('input[name="url_formAdd"]').val(),url_formEdit=$('input[name="url_formEdit"]').val(),url_get=$('input[name="url_get"]').val(),url_getOnce=$('input[name="url_getOnce"]').val(),url_remove=$('input[name="url_remove"]').val(),url_removeAll=$('input[name="url_removeAll"]').val();let url_next="";const Toast=Swal.mixin({toast:!0,position:"top-end",showConfirmButton:!1,timer:3e3,timerProgressBar:!0,didOpen:e=>{e.addEventListener("mouseenter",Swal.stopTimer),e.addEventListener("mouseleave",Swal.resumeTimer)}});$(function(){getPromo()});let scrollEnabled=!0;const getPromo=(e=url_get)=>{$.ajax({headers:{"X-CSRF-TOKEN":token_csrf},url:e,method:"GET",beforeSend:function(){scrollEnabled=!1},success:function(e){null==(url_next=e.next_page_url)||null==url_next||""==url_next?spinner_promo.hide():scrollEnabled=!0,e.data==[]||""==e.data||null==e.data||null==e.data?(container_promo_content.hide(),container_promo_contentNo.show(),flag_previousRetrieveNull=!0):(1==flag_previousRetrieveNull&&(container_promo_content.show(),container_promo_contentNo.hide(),flag_previousRetrieveNull=!1),$.each(e.data,function(e,o){container_promo_row.append('<div class="col-lg-4 col-md-6 col-12 card-promo"><div class="card mb-3" style="max-width:100%"><a href="javascript:showImage(\''+o.photo+"', '"+o.name+'\')"><img class="card-img-top rr-image-responsive" src="'+o.photo+'" alt="Poster Promo ->'+o.name+'"></a><div class="card-body h-100 card-body-promo-card"><h5 class="card-title font-weight-bolder">'+o.name+'</h5><p class="card-text mb-0 font-weight-lighter">'+o.post+'</p><p class="card-text mb-4"><small class="text-muted">Ditambahkan '+o.created_at+'</small></p><div class="d-flex justify-content-end btn-promo-container"><div class="btn-group" data-id="'+o.id+'"><button class="btn btn-danger btn-promo-remove"><i class="fas fa-trash-alt"></i></button><button class="btn btn-primary btn-promo-edit"><i class="fa fa-pencil-alt"></i></button></div></div></div></div></div>')}))},error:function(e){Swal.fire({icon:"error",title:"Oops...",text:"Something went wrong!"})}})};$(window).on("scroll",function(){if(null==url_next||null==url_next||""==url_next);else if(scrollEnabled){var e=Math.floor($("html").height());Math.floor($(window).height()+$(window).scrollTop())>=e&&getPromo(url_next)}}),btnPromo_addPromo.on("click",function(){toggle_form="add",btnPromo_submit.html(btnContent_add),modal_promo.modal("show")}),container_promo_row.on("click",btnPromo_edit,function(){toggle_form="edit",btnPromo_submit.html(btnContent_edit),resetForm(),edit_promo_id=$(this).parent().data("id"),overlay_promo_modal.show(),modal_promo.modal("show"),$.ajax({headers:{"X-CSRF-TOKEN":token_csrf},url:url_getOnce,data:{id:edit_promo_id},method:"POST",complete:function(){overlay_promo_modal.fadeOut()},success:function(e){input_name.val(e.name),textarea_post.text(e.post),textarea_link.text(e.link),input_image.val(e.photo),edit_promo_originPhoto=e.photo,image_promo.attr("src",e.photo_link);let o=moment(e.period_start,"YYYY-MMMM-DD","id").format("DD MMMM YYYY"),t=moment(e.period_end,"YYYY-MMMM-DD","id").format("DD MMMM YYYY");input_daterange.data("daterangepicker").setStartDate(o),input_daterange.data("daterangepicker").setEndDate(t),input_daterange.val(o+" - "+t);let r=e.period_start+"/"+e.period_end;input_period.val(r),image_promo_stack.hasClass("rr-promo-add-image-stack-static")&&image_promo_stack.removeClass("rr-promo-add-image-stack-static").addClass("rr-promo-add-image-stack-hover")},error:function(e){Swal.fire({icon:"error",title:"Oops...",text:"Something went wrong!"})}})}),container_promo_row.on("click",btnPromo_remove,function(){let e=$(this).parent().data("id");Swal.fire({title:"Hapus Promo ini?",text:"Promo yang sudah dihapus tidak dapat dikembalikan kembali.",icon:"question",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"Ya",cancelButtonText:"Tidak",focusCancel:!0,allowOutsideClick:!1}).then(o=>{o.isConfirmed&&$.ajax({headers:{"X-CSRF-TOKEN":token_csrf},url:url_remove,data:{id:e},method:"POST",beforeSend:function(){showLoadingSwal("Menghapus Promo","Harap tunggu sistem sedang menghapus promo ini.")},success:function(o){$('[data-id="'+e+'"]').parents(".card-promo").remove(),container_promo_row.is(":empty")&&(container_promo_content.hide(),container_promo_contentNo.show(),flag_previousRetrieveNull=!0),Toast.fire({icon:"success",title:"Promo telah dihapus"})},error:function(e){Swal.fire({icon:"error",title:"Oops...",text:"Something went wrong!"})}})})}),image_input.on("change",function(e){var o,t,r=e.target.files,a=function(e){image_input.val(""),image_cropper.src=e};r&&r.length>0&&(t=r[0],URL?a(URL.createObjectURL(t)):FileReader&&((o=new FileReader).onload=function(e){a(o.result)},o.readAsDataURL(t))),image_promo_container.hide(),image_cropper_container.show(),cropper=new Cropper(image_cropper,{aspectRatio:16/9,viewMode:3})}),image_cropper_btn.on("click",function(){var e;if(cropper){e=cropper.getCroppedCanvas(),image_promo.attr("src");let o=e.toDataURL();image_promo.attr("src",o),input_image.val(o),image_cropper.src=image_spinner_src,image_promo_stack.hasClass("rr-promo-add-image-stack-static")&&image_promo_stack.removeClass("rr-promo-add-image-stack-static").addClass("rr-promo-add-image-stack-hover"),image_promo_container.show(),image_cropper_container.hide(),cropper.destroy()}}),image_cropper_btn_zoomIn.on("click",function(e){cropper.zoom(.1)}),image_cropper_btn_zoomOut.on("click",function(e){cropper.zoom(-.1)}),image_cropper_btn_rotateLeft.on("click",function(e){cropper.rotate(-45)}),image_cropper_btn_rotateRight.on("click",function(e){cropper.rotate(45)}),image_cropper_btn_modeDrag.on("click",function(e){cropper.setDragMode("move")}),image_cropper_btn_modeCrop.on("click",function(e){cropper.setDragMode("crop")}),input_daterange.daterangepicker({autoUpdateInput:!1,minDate:moment(),startDate:moment(),endDate:moment().add(1,"months"),locale:{format:"DD MMMM YYYY",applyLabel:"Pilih",cancelLabel:"Hapus",separator:" - ",daysOfWeek:["Min","Sen","Sel","Rab","Kam","Jum","Sab"],monthNames:["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"],firstDay:1},opens:"center",drops:"auto"},function(e,o,t){}),input_daterange.on("apply.daterangepicker",function(e,o){$(this).val(o.startDate.format("DD MMMM YYYY")+" - "+o.endDate.format("DD MMMM YYYY"));let t=$(this).val().split(" - ");$.each(t,function(e,o){t[e]=moment(o,"DD MMMM YYYY","id").format("YYYY-MM-DD")});let r=t[0]+"/"+t[1];input_period.val(r)}),input_daterange.on("cancel.daterangepicker",function(e,o){$(this).val(""),input_period.val("")}),formPromo.validate({rules:{name:{required:!0,minlength:8},post:{required:!0,minlength:12},link:{required:!0}},messages:{name:{required:"Harap masukkan Judul Promo",minlength:"Setidaknya harus 5 karakter untuk Judul Promo."},post:{required:"Harap masukkan Keterangan Promo",minlength:"Setidaknya harus 12 karakter untuk Keterangan Promo."},link:"Harap masukkan pesan teks, untuk pesan otomatis saat tombol order diklik."},errorElement:"span",errorPlacement:function(e,o){e.addClass("invalid-feedback"),o.closest(".form-group").append(e)},highlight:function(e,o,t){$(e).addClass("is-invalid")},unhighlight:function(e,o,t){$(e).removeClass("is-invalid")},submitHandler:function(e){let o=input_image.val(),t=input_period.val();if(""==t||null==t||null==t)return Swal.fire({icon:"error",title:"Periode promo tidak boleh kosong.",text:"Harap tambahkan periode promo."}),!1;if(""==o||null==o||null==o)Swal.fire({icon:"error",title:"Poster tidak boleh kosong.",text:"Harap tambahkan poster promo."});else{let r=t.split("/"),a={name:e.name.value,post:e.post.value,period_start:r[0],period_end:r[1],link:e.link.value,photo:o};"add"==toggle_form?$.ajax({headers:{"X-CSRF-TOKEN":token_csrf},url:url_formAdd,method:"POST",data:a,beforeSend:function(){showLoadingSwal("Menambahkan Promo..","Harap Tunggu, sistem sedang menambahkan promo.")},success:function(e){Toast.fire({icon:"success",title:"Promo telah ditambahkan"}),resetForm(),modal_promo.modal("hide"),container_promo_row.empty(),spinner_promo.show(),getPromo(url_get)},error:function(e){showErrorSwal_validation(e.responseJSON)}}):"edit"==toggle_form?(a.id=edit_promo_id,a.photo_origin=edit_promo_originPhoto,$.ajax({headers:{"X-CSRF-TOKEN":token_csrf},url:url_formEdit,method:"POST",data:a,beforeSend:function(){resetForm(),modal_promo.modal("hide"),showLoadingSwal("Menyimpan Promo..","Harap Tunggu, sistem sedang menyimpan perubahanmu.")},success:function(e){Toast.fire({icon:"success",title:"Promo telah disimpan"});let o=container_promo_row.find('div[data-id="'+e.id+'"]');o.parent().siblings("h5.card-title").text(e.name),o.parent().siblings("p.card-text.mb-0.font-weight-lighter").text(e.post),o.parents("div.col-lg-7.col-md-8").siblings("div.col-lg-5.col-md-4").find("img").attr("src",e.photo)},error:function(e){showErrorSwal_validation(e.responseJSON)}})):Swal.fire({icon:"error",title:"Oops...",text:"Something went wrong!"})}}}),modal_promo.on("hidden.bs.modal",function(){"edit"==toggle_form&&resetForm()});const resetForm=()=>{formPromo[0].reset(),textarea_post.text(""),textarea_link.text(""),image_promo.attr("src",image_default),image_promo_stack.hasClass("rr-promo-add-image-stack-hover")&&image_promo_stack.removeClass("rr-promo-add-image-stack-hover").addClass("rr-promo-add-image-stack-static"),input_image.val(""),input_period.val(""),input_daterange.data("daterangepicker").setStartDate(moment()),input_daterange.data("daterangepicker").setEndDate(moment().add(1,"months"))},showErrorSwal_validation=e=>{let o="";$.each(e,function(e,t){$.each(t,function(e,t){o+='<li style="list-style-type: none;">'+t+"</li>"})}),Swal.fire({icon:"error",title:"Error",html:o})},showLoadingSwal=(e,o)=>{Swal.fire({icon:"info",title:e,html:"<p>"+o+'<br/><br/><img src="'+image_spinner_src+'" alt="loading icon" style="width: 5em;"></p>',showConfirmButton:!1,allowOutsideClick:!1,allowEscapeKey:!1,allowEnterKey:!1})};var imageViewer_modal=$(".imageViewer-modal"),img=document.getElementById("myImg"),modalImg=$("#imageViewer-img"),captionText=document.getElementById("imageViewer-caption"),imageViewer_closeBtn=document.getElementsByClassName("imageViewer-close")[0];function showImage(e,o){modalImg.attr("src",e),captionText.innerHTML=o,imageViewer_modal.css("display","block")}imageViewer_closeBtn.onclick=function(){imageViewer_modal.css("display","none")};
